name: Build APK

on:
  push:
    branches:
      - '*'
    
jobs:
  check:
    name: Check whether to build or not
    runs-on: ubuntu-latest
    outputs:
      buildapk: ${{steps.step2.outputs.buildapk}}
    steps:
      - id: step1
        uses: actions/checkout@v3
      - id: step2
        run: echo "buildapk=$(cat buildapk.txt)" >> $GITHUB_OUTPUT
  test:
    name: Test output
    needs: check
    runs-on: ubuntu-latest
    steps:
      - run: echo ${{needs.check.outputs.buildapk}}
  build:
    name: Building Debug APK
    needs: check
    if: needs.check.outputs.buildapk == '1'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Flutter Setup
        uses: subosito/flutter-action@v2.8.0
        with:
          channel: 'stable'
      - name: Firebase login
        run: |
          dart pub global activate flutterfire_cli
<<<<<<< HEAD
          curl -sL https://firebase.tools | bash
          flutterfire configure -p ${{ secrets.PROJ_ID }} --platforms="android,ios" -i com.example.navigation \
          -a com.example.navigation -m -a com.example.navigation --token=${{ secrets.FIREBASE_TOKEN }}
        shell: bash
=======
          flutterfire configure -p ${{ secrets.PROJ_ID }} --platforms=android,ios --token=${{ secrets.FIREBASE_TOKEN }}
>>>>>>> a48a975 (Updated workflow file to include project platform and firebase token)
      - name: Extract SDK and load Access keys
        run: |
          curl -o heresdk-explore-flutter.tar.gz https://dl.dropboxusercontent.com/s/2rgack3gpf0j5kp/heresdk-explore-flutter-4.13.0.0.3315.tar.gz?dl=0
          echo "${{ secrets.HereCreds }}" > credentials.env
          mkdir -p plugins/here_sdk
          tar xzf heresdk-explore-flutter.tar.gz -C plugins/here_sdk
        shell: bash
      - name: Building APK
        run: |
          flutter pub get
          flutter build apk
      - uses: tj-actions/branch-names@v6
      - name: Create Github release for Navigation Debug APK
        run: |
          echo "${{ secrets.RELEASE_SCRIPT }}" > release.sh
          chmod +x release.sh
          ./release.sh "${{ github.event.head_commit.message }}" "${{ steps.branch-name.outputs.ref_branch }}"
      
